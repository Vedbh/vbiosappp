<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Private P2P Chat</title>
<style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; height: 100vh; margin:0; padding:20px;}
    #chat { width: 100%; max-width: 600px; height: 400px; border: 1px solid #555; overflow-y: auto; padding:10px; background: #222; margin-bottom:10px; }
    #message { width: 80%; padding:5px; }
    #sendBtn { padding:5px 10px; }
    #apiKey { padding:5px; width: 50%; margin-bottom:10px; }
    .message { margin:5px 0; padding:5px; border-radius:5px; }
    .sent { background: #0a84ff; color: white; text-align: right;}
    .received { background: #444; color: #eee; text-align: left;}
</style>
</head>
<body>

<h2>Private P2P Chat (Same Network)</h2>
<input type="text" id="apiKey" placeholder="Enter your API key">
<div id="chat"></div>
<input type="text" id="message" placeholder="Type message here">
<button id="sendBtn">Send</button>

<script>
// ==== CONFIG ====
const MY_API_KEY = "123456"; // Set your API key
let remoteConnection = null;
let dataChannel = null;

// ==== DOM ELEMENTS ====
const chat = document.getElementById("chat");
const messageInput = document.getElementById("message");
const sendBtn = document.getElementById("sendBtn");
const apiInput = document.getElementById("apiKey");

// ==== CHECK API KEY ====
function checkAPIKey() {
    if(apiInput.value !== MY_API_KEY){
        alert("Incorrect API key! Access denied.");
        return false;
    }
    return true;
}

// ==== DISPLAY MESSAGE ====
function addMessage(text, type){
    const div = document.createElement("div");
    div.className = "message " + type;
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

// ==== SEND MESSAGE ====
sendBtn.onclick = () => {
    if(!checkAPIKey()) return;
    const msg = messageInput.value.trim();
    if(msg === "" || !dataChannel) return;
    dataChannel.send(msg);
    addMessage(msg, "sent");
    messageInput.value = "";
}

// ==== WEBRTC SETUP ====
async function initConnection() {
    const configuration = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
    remoteConnection = new RTCPeerConnection(configuration);

    // Receive channel
    remoteConnection.ondatachannel = (event) => {
        dataChannel = event.channel;
        dataChannel.onmessage = (e) => addMessage(e.data, "received");
    };

    // ICE candidate
    remoteConnection.onicecandidate = (event) => {
        if(event.candidate){
            console.log("New ICE candidate:", JSON.stringify(event.candidate));
        }
    };

    // Create DataChannel (for initiating device)
    dataChannel = remoteConnection.createDataChannel("chat");
    dataChannel.onmessage = (e) => addMessage(e.data, "received");

    // Create Offer
    const offer = await remoteConnection.createOffer();
    await remoteConnection.setLocalDescription(offer);
    console.log("Copy this Offer and send to remote device:\n", JSON.stringify(offer));
}

// ==== HANDLE REMOTE ANSWER ====
async function handleAnswer(answerStr){
    const answer = JSON.parse(answerStr);
    await remoteConnection.setRemoteDescription(new RTCSessionDescription(answer));
    alert("Connection established!");
}

// ==== PROMPT FOR REMOTE ANSWER ====
setTimeout(() => {
    if(confirm("Do you have remote Answer from other device?")){
        const ans = prompt("Paste remote Answer JSON here:");
        handleAnswer(ans);
    }
}, 1000);

// ==== INIT ====
initConnection();
</script>

</body>
</html>
